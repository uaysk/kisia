server {
    listen 80;

    # 1. ì ‘ê·¼ í—ˆê°€ë¥¼ ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸ (/getaccess)
    location /getaccess {
        # FastAPI ì„œë²„ë¡œ ìš”ì²­ì„ ê·¸ëŒ€ë¡œ ì „ë‹¬
        proxy_pass http://fastapi_app:8000/getaccess;
    }

    # 2. ë³´í˜¸í•  ë¦¬ì†ŒìŠ¤ ê²½ë¡œ (/protected)
    location /protected {
        # ëª¨ë“  ìš”ì²­ì€ ë¨¼ì € /_auth ê²½ë¡œë¡œ ì¸ì¦ì„ ìš”ì²­í•¨
        auth_request /_auth;

        # ì¸ì¦ ì„±ê³µ ì‹œ ë³´ì—¬ì¤„ ë‚´ìš© (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨í•œ ë©”ì‹œì§€)
        return 200 "ğŸ‰ Welcome! You have access to the protected resource.";
    }

    # 3. ì‹¤ì œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë‚´ë¶€ ê²½ë¡œ
    location = /_auth {
        # ì´ ê²½ë¡œëŠ” Nginx ë‚´ë¶€ì—ì„œë§Œ í˜¸ì¶œ ê°€ëŠ¥
        internal;

        # FastAPIì˜ /auth ì—”ë“œí¬ì¸íŠ¸ë¡œ ì¸ì¦ ìš”ì²­ ì „ë‹¬
        proxy_pass http://fastapi_app:8000/auth;

        # ì¸ì¦ ìš”ì²­ì—ëŠ” bodyê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë¹„ì›€
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;

        # ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„: ì‹¤ì œ ì‚¬ìš©ìì˜ IPë¥¼ 'X-Real-IP' í—¤ë”ì— ë‹´ì•„ ì „ë‹¬
        proxy_set_header X-Real-IP $remote_addr;
    }
}