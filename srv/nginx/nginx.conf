# nginx/default.conf

# FastAPI ì„œë²„ë¥¼ upstreamìœ¼ë¡œ ì •ì˜
upstream fastapi_server {
    server fastapi_app:8000;
}

server {
    listen 80;

    # 1. ì ‘ê·¼ í—ˆê°€ë¥¼ ë°›ëŠ” ì—”ë“œí¬ì¸íŠ¸
    location /getaccess {
        proxy_pass http://fastapi_server/getaccess;
        # ì´ ê²½ë¡œë¡œ ìš”ì²­ ì‹œì—ë„ ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ IPë¥¼ í—¤ë”ì— ë‹´ì•„ ì „ë‹¬
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
    }

    # 2. ë³´í˜¸í•  ë¦¬ì†ŒìŠ¤ ê²½ë¡œ
    location /protected {
        # ëª¨ë“  ìš”ì²­ì€ ë¨¼ì € /_auth ê²½ë¡œë¡œ ì¸ì¦ì„ ìš”ì²­í•¨
        auth_request /_auth;

        # ì¸ì¦ ì„±ê³µ ì‹œ(auth_requestê°€ 2xx ì‘ë‹µ ë°˜í™˜ ì‹œ) ì‹¤í–‰ë¨
        return 200 "ğŸ‰ Welcome! You have access to the protected resource.";
    }

    # 3. ì‹¤ì œ ì¸ì¦ì„ ì²˜ë¦¬í•˜ëŠ” ë‚´ë¶€ ê²½ë¡œ
    location = /_auth {
        internal; # Nginx ë‚´ë¶€ ìš”ì²­ìœ¼ë¡œë§Œ ì ‘ê·¼ ê°€ëŠ¥

        # ì¸ì¦ ìš”ì²­ì„ FastAPI ì„œë²„ë¡œ ì „ë‹¬
        proxy_pass http://fastapi_server/auth;
        
        # ì¸ì¦ ìš”ì²­ì—ëŠ” bodyê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ë¹„ì›€
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # ê°€ì¥ ì¤‘ìš”í•œ ë¶€ë¶„: ì‹¤ì œ ì‚¬ìš©ìì˜ IPë¥¼ 'X-Real-IP' í—¤ë”ì— ë‹´ì•„ ì „ë‹¬
        proxy_set_header X-Real-IP $remote_addr;
    }
}