# nginx/default.conf

# FastAPI 서버를 upstream으로 정의
upstream fastapi_server {
    server fastapi_app:8000;
}

server {
    listen 80;

    # 1. 접근 허가를 받는 엔드포인트
    location /getaccess {
        proxy_pass http://fastapi_server/getaccess;
        # 이 경로로 요청 시에도 실제 클라이언트 IP를 헤더에 담아 전달
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
    }

    # 2. 보호할 리소스 경로
    location /protected {
        # 모든 요청은 먼저 /_auth 경로로 인증을 요청함
        auth_request /_auth;

        # 인증 성공 시(auth_request가 2xx 응답 반환 시) 실행됨
        return 200 "🎉 Welcome! You have access to the protected resource.";
    }

    # 3. 실제 인증을 처리하는 내부 경로
    location = /_auth {
        internal; # Nginx 내부 요청으로만 접근 가능

        # 인증 요청을 FastAPI 서버로 전달
        proxy_pass http://fastapi_server/auth;
        
        # 인증 요청에는 body가 필요 없으므로 비움
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";

        # 가장 중요한 부분: 실제 사용자의 IP를 'X-Real-IP' 헤더에 담아 전달
        proxy_set_header X-Real-IP $remote_addr;
    }
}