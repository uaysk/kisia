server {
    listen 80;

    # 1. 접근 허가를 받는 엔드포인트 (/getaccess)
    location /getaccess {
        # FastAPI 서버로 요청을 그대로 전달
        proxy_pass http://fastapi_app:8000/getaccess;
    }

    # 2. 보호할 리소스 경로 (/protected)
    location /protected {
        # 모든 요청은 먼저 /_auth 경로로 인증을 요청함
        auth_request /_auth;

        # 인증 성공 시 보여줄 내용 (여기서는 간단한 메시지)
        return 200 "🎉 Welcome! You have access to the protected resource.";
    }

    # 3. 실제 인증을 처리하는 내부 경로
    location = /_auth {
        # 이 경로는 Nginx 내부에서만 호출 가능
        internal;

        # FastAPI의 /auth 엔드포인트로 인증 요청 전달
        proxy_pass http://fastapi_app:8000/auth;

        # 인증 요청에는 body가 필요 없으므로 비움
        proxy_pass_request_body off;
        proxy_set_header Content-Length "";
        proxy_set_header X-Original-URI $request_uri;

        # 가장 중요한 부분: 실제 사용자의 IP를 'X-Real-IP' 헤더에 담아 전달
        proxy_set_header X-Real-IP $remote_addr;
    }
}